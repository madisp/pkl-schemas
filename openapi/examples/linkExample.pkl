amends "../OpenApi.pkl"

import "@openapi/Schema.pkl"

import "../Utils.pkl" as $

// pkl equivalent of
// https://github.com/OAI/OpenAPI-Specification/blob/main/examples/v3.0/link-example.yaml
// render back to yaml with:
// pkl eval -f yaml examples/linkExample.pkl

openapi = "3.0.0"

info {
  title = "Link Example"
  version = "1.0.0"
}

paths {
  ["/2.0/users/{username}"] {
    get {
      operationId = "getUserByName"
      parameters {
        new {
          name = "username"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
      }
      responses {
        ["200"] {
          description = "The User"
          content {
            ["application/json"] {
              schema = $.ref("#/components/links/UserRepositories")
            }
          }
          links {
            ["userRepository"] = $.ref("#/components/links/UserRepository")
          }
        }
      }
    }
  }
  ["/2.0/repositories/{username}/{slug}"] {
    get {
      operationId = "getRepository"
      parameters {
        new {
          name = "username"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
        new {
          name = "slug"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
      }
      responses {
        ["200"] {
          description = "The repository"
          content {
            ["application/json"] {
              schema = $.ref("#/components/schemas/repository")
            }
          }
          links {
            ["repositoryPullRequests"] = $.ref("#/components/links/RepositoryPullRequests")
          }
        }
      }
    }
  }
  ["/2.0/repositories/{username}/{slug}/pullrequests"] {
    get {
      operationId = "getPullRequestsByRepository"
      parameters {
        new {
          name = "username"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
        new {
          name = "slug"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
        new {
          name = "state"
          `in` = "query"
          schema {
            type = "string"
            enum {
              "open"
              "merged"
              "declined"
            }
          }
        }
      }
      responses {
        ["200"] {
          description = "an array of pull request objects"
          content {
            ["application/json"] {
              schema {
                type = "array"
                items = $.ref("#/componentes/schemas/pullrequest")
              }
            }
          }
        }
      }
    }
  }
  ["/2.0/repositories/{username}/{slug}/pullrequests/{pid}"] {
    get {
      operationId = "getPullRequestsById"
      parameters {
        new {
          name = "username"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
        new {
          name = "slug"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
        new {
          name = "pid"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
      }
      responses {
        ["200"] {
          description = "a pull request object"
          content {
            ["application/json"] {
              schema = $.ref("#/components/schemas/pullrequest")
            }
          }
          links {
            ["pullRequestMerge"] = $.ref("#/components/links/PullRequestMerge")
          }
        }
      }
    }
  }
  ["/2.0/repositories/{username}/{slug}/pullrequests/{pid}/merge"] {
    post {
      operationId = "mergePullRequest"
      parameters {
        new {
          name = "username"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
        new {
          name = "slug"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
        new {
          name = "pid"
          `in` = "path"
          required = true
          schema {
            type = "string"
          }
        }
      }
      responses {
        ["204"] {
          description = "the PR was successfully merged"
        }
      }
    }
  }
}

components {
  links {
    ["UserRepositories"] {
      // returns array of '#/components/schemas/repository'
      operationId = "getRepositoriesByOwner"
      parameters {
        ["username"] = "$response.body#/username"
      }
    }
    ["UserRepository"] {
      // returns '#/components/schemas/repository'
      operationId = "getRepository"
      parameters {
        ["username"] = "$response.body#/owner/username"
        ["slug"] = "$response.body#/slug"
      }
    }
    ["RepositoryPullRequests"] {
      // returns '#/components/schemas/pullrequest'
      operationId = "getPullRequestsByRepository"
      parameters {
        ["username"] = "$response.body#/owner/username"
        ["slug"] = "$response.body#/slug"
      }
    }
    ["PullRequestMerge"] {
      // executes /2.0/repositories/{username}/{slug}/pullrequests/{pid}/merge
      operationId = "mergePullRequest"
      parameters {
        ["username"] = "$response.body#/author/username"
        ["slug"] = "$response.body#/repository/slug"
        ["pid"] = "$response.body#/id"
      }
    }
  }
  schemas {
    ["user"] {
      type = "object"
      properties {
        ["username"] = new Schema.PropertySchema {
          type = "string"
        }
        ["uuid"] = new Schema.PropertySchema {
          type = "string"
        }
      }
    }
    ["repository"] {
      type = "object"
      properties {
        ["slug"] = new Schema.PropertySchema {
          type = "string"
        }
        ["owner"] = $.ref("#/components/schemas/user")
      }
    }
    ["pullrequest"] {
      type = "object"
      properties {
        ["id"] = new Schema.PropertySchema {
          type = "integer"
        }
        ["title"] = new Schema.PropertySchema {
          type = "string"
        }
        ["repository"] = $.ref("#/components/schemas/repository")
        ["author"] = $.ref("#/components/schemas/user")
      }
    }
  }
}